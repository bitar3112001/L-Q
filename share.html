<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù…Ø¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ù‡Ù‰</title>
  <style>
    :root{--ink:#1c1b1a;--accent:#7b4b2a;--bg:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Arial,sans-serif}
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    .card{border:1px solid #eee;border-radius:16px;padding:16px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.04)}
    h1{margin:0 0 8px}
    .muted{color:#666}
    .grid{display:grid;gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    video,canvas{width:100%;border-radius:12px;background:#111;max-height:70vh;object-fit:cover}
    .btn{padding:14px 16px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;font-size:1rem}
    .btn.alt{background:#333}
    .btn:active{transform:scale(.98)}
    label{display:block;font-weight:600;margin:8px 0 4px}
    input[type="text"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px}
    input[type="range"]{width:100%}
    .hint{font-size:.9rem;color:#555}
    .stack{display:grid;gap:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“¸ Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© ÙˆØ´Ø§Ø±ÙƒÙ‡Ø§ Ù…Ø¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ù‡Ù‰</h1>
      <p class="muted">Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©. Ø§Ù„ØªÙ‚Ø· Ø§Ù„ØµÙˆØ±Ø©ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ø«Ù… Ø´Ø§Ø±ÙƒÙ‡Ø§ Ø£Ùˆ Ù†Ø²Ù‘Ù„Ù‡Ø§.</p>

      <div class="grid">
        <!-- Camera preview -->
        <video id="v" playsinline autoplay muted class="hidden"></video>

        <!-- Captured/composited result -->
        <canvas id="c" class="hidden"></canvas>

        <!-- Controls -->
        <div class="stack">
          <div class="row">
            <button class="btn" id="startCam">ğŸ¥ Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button class="btn" id="snap" disabled>ğŸ“¸ Ø§Ù„ØªÙ‚Ø·</button>
            <button class="btn alt" id="retake" disabled>ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØ±</button>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Ù†Øµ Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ù‡Ø§Ø´ØªØ§Ù‚/Ø­Ø³Ø§Ø¨)</label>
              <input id="caption" type="text" placeholder="#Ù‚Ù‡ÙˆØ©_Ø³Ø¹ÙŠØ¯Ø© @CafeName" />
              <div class="hint">Ø³ÙŠØ¸Ù‡Ø± Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø©.</div>
            </div>
            <div style="width:180px">
              <label>Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø±</label>
              <input id="logoScale" type="range" min="0.2" max="1.5" step="0.1" value="0.6" />
            </div>
          </div>

          <div class="row">
            <button class="btn" id="shareBtn" disabled>ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø¸Ø§Ù…)</button>
            <button class="btn alt" id="downloadBtn" disabled>â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„</button>
            <button class="btn alt" id="copyBtn" disabled>ğŸ“‹ Ù†Ø³Ø®</button>
          </div>

          <div id="msg" class="muted"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const LOGO_SRC = 'assets/logo.jpq';      // Ø´ÙÙ‘Ø§Ù PNGØŒ Ù†ÙØ³ Ø§Ù„Ù†Ø·Ø§Ù‚
    const OUT_W = 1080, OUT_H = 1920;        // 9:16 Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø³ØªÙˆØ±ÙŠ
    const PADDING = 24;

    // --- ELEMENTS ---
    const v = document.getElementById('v');
    const c = document.getElementById('c'), ctx = c.getContext('2d');
    const startCamBtn = document.getElementById('startCam');
    const snapBtn = document.getElementById('snap');
    const retakeBtn = document.getElementById('retake');
    const shareBtn = document.getElementById('shareBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const captionInput = document.getElementById('caption');
    const logoScaleInput = document.getElementById('logoScale');
    const msg = document.getElementById('msg');

    const logo = new Image(); logo.src = LOGO_SRC;
    let stream = null;
    let lastBlob = null; // cached composite for share/download/copy

    function setUI(state){
      // state: 'idle' | 'preview' | 'captured'
      if (state === 'preview') {
        v.classList.remove('hidden');
        c.classList.add('hidden');
        snapBtn.disabled = false;
        retakeBtn.disabled = true;
        shareBtn.disabled = downloadBtn.disabled = copyBtn.disabled = true;
      } else if (state === 'captured') {
        v.classList.add('hidden');
        c.classList.remove('hidden');
        snapBtn.disabled = true;
        retakeBtn.disabled = false;
        shareBtn.disabled = downloadBtn.disabled = false;
        copyBtn.disabled = !('clipboard' in navigator && 'ClipboardItem' in window);
      } else {
        v.classList.add('hidden');
        c.classList.add('hidden');
        snapBtn.disabled = true;
        retakeBtn.disabled = true;
        shareBtn.disabled = downloadBtn.disabled = copyBtn.disabled = true;
      }
    }
    setUI('idle');

    async function startCamera(){
      msg.textContent = '';
      try{
        // try back camera first
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } , width:{ideal:1280}, height:{ideal:720} },
          audio: false
        });
        v.srcObject = stream;
        await v.play(); // may require user gesture on some iOS
        setUI('preview');
      }catch(e){
        console.error(e);
        msg.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙˆHTTPS Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ Ù…ØªØµÙØ­Ù‹Ø§ Ø¢Ø®Ø±.';
      }
    }

    function stopCamera(){
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    function coverDrawFromVideo() {
      // draw current video frame into OUT_W x OUT_H with center-crop (cover)
      c.width = OUT_W; c.height = OUT_H;
      const W = OUT_W, H = OUT_H;
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);

      const vw = v.videoWidth, vh = v.videoHeight;
      if (!vw || !vh) return;

      const tr = W/H, r = vw/vh;
      let sx,sy,sw,sh;
      if (r > tr){ // video wider than target
        sh = vh; sw = sh*tr; sx = (vw - sw)/2; sy = 0;
      } else {
        sw = vw; sh = sw/tr; sx = 0; sy = (vh - sh)/2;
      }
      ctx.drawImage(v, sx,sy,sw,sh, 0,0,W,H);
    }

    function drawOverlay() {
      const W = c.width, H = c.height;

      // caption
      const caption = captionInput.value.trim();
      if (caption) {
        if (!CanvasRenderingContext2D.prototype.roundRect) {
          CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
            if (w < 2*r) r = w/2; if (h < 2*r) r = h/2;
            this.beginPath(); this.moveTo(x+r,y);
            this.arcTo(x+w,y,x+w,y+h,r); this.arcTo(x+w,y+h,x,y+h,r);
            this.arcTo(x,y+h,x,y,r); this.arcTo(x,y,x+w,y,r);
            this.closePath(); return this;
          };
        }
        ctx.font = 'bold 42px system-ui, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        const textW = ctx.measureText(caption).width;
        const padX = 16, padY = 10;
        const boxW = textW + padX*2, boxH = 54 + padY;
        const boxX = (W - boxW)/2, boxY = H - PADDING - boxH;
        ctx.fillStyle = 'rgba(0,0,0,0.35)';
        ctx.roundRect(boxX, boxY, boxW, boxH, 12); ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.fillText(caption, W/2, H - PADDING - 12);
      }

      // logo bottom-right
      if (logo.complete && logo.naturalWidth > 0) {
        const s = parseFloat(logoScaleInput.value || '0.6');
        const baseSize = Math.min(W, H) * 0.22 * s;
        const ratio = logo.naturalWidth / logo.naturalHeight;
        let lw = baseSize, lh = baseSize / ratio;
        if (ratio < 1) { lh = baseSize; lw = baseSize * ratio; }
        const lift = (caption ? 70 : 0);
        const x = W - PADDING - lw;
        const y = H - PADDING - lh - lift;
        ctx.drawImage(logo, x, y, lw, lh);
      }
    }

    async function compositeAndCacheBlob(){
      return new Promise(res => c.toBlob(b => {
        lastBlob = b;
        res(b);
      }, 'image/png', 0.95));
    }

    // --- Events ---
    startCamBtn.addEventListener('click', startCamera);

    snapBtn.addEventListener('click', async ()=>{
      coverDrawFromVideo();
      drawOverlay();
      setUI('captured');
      await compositeAndCacheBlob();
      msg.textContent = 'ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„ØªÙ†Ø²ÙŠÙ„.';
    });

    retakeBtn.addEventListener('click', ()=>{
      setUI('preview');
      msg.textContent = '';
    });

    captionInput.addEventListener('input', ()=>{
      if (!c.classList.contains('hidden')) { // live update on captured image
        coverDrawFromVideo(); // keep last frame look similar
        drawOverlay();
        lastBlob = null;
      }
    });
    logoScaleInput.addEventListener('input', ()=>{
      if (!c.classList.contains('hidden')) {
        coverDrawFromVideo();
        drawOverlay();
        lastBlob = null;
      }
    });

    // SHARE
    shareBtn.addEventListener('click', async ()=>{
      if (!lastBlob) await compositeAndCacheBlob();
      const file = new File([lastBlob], 'coffee-story.png', { type: 'image/png' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'Ù‚ØµØªÙŠ Ù…Ø¹ Ø§Ù„Ù‚Ù‡ÙˆØ©',
            text: captionInput.value || 'ÙˆÙ‚Øª Ø§Ù„Ù‚Ù‡ÙˆØ© â˜•'
          });
          msg.textContent = 'ØªÙ… ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©. Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.';
        } catch (e) {
          msg.textContent = 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù†Ø³Ø®.';
        }
      } else {
        msg.textContent = 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ØªØµÙØ­. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù†Ø³Ø®.';
      }
    });

    // DOWNLOAD
    downloadBtn.addEventListener('click', async ()=>{
      if (!lastBlob) await compositeAndCacheBlob();
      const url = URL.createObjectURL(lastBlob);
      const a = document.createElement('a');
      a.href = url; a.download = 'coffee-story.png';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      msg.textContent = 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.';
    });

    // COPY
    copyBtn.addEventListener('click', async ()=>{
      try {
        if (!lastBlob) await compositeAndCacheBlob();
        if (navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([ new ClipboardItem({ 'image/png': lastBlob }) ]);
          msg.textContent = 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ØµÙˆØ±Ø©. Ø§Ù„ØµÙ‚Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.';
        } else {
          msg.textContent = 'Ø§Ù„Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„.';
        }
      } catch(e){
        msg.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„.';
      }
    });

    // Helpful hints
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      msg.textContent = 'ØªÙ„Ù…ÙŠØ­: ÙØ¹Ù‘Ù„ HTTPS Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø­ØªÙ‰ ØªØ¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ Ø£ØºÙ„Ø¨ Ø§Ù„Ù‡ÙˆØ§ØªÙ.';
    }

    // Clean up camera on page hide
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopCamera(); });
    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
