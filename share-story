<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø´Ø§Ø±Ùƒ ØµÙˆØ±ØªÙƒ Ù…Ø¹ Ø§Ù„Ù…Ù‚Ù‡Ù‰</title>
  <style>
    :root{--ink:#1c1b1a;--accent:#7b4b2a;--bg:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Arial,sans-serif}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{border:1px solid #eee;border-radius:16px;padding:16px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.04)}
    h1{margin:0 0 10px}
    .actions{display:grid;gap:10px;margin-top:12px}
    .btn{padding:14px 16px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;font-size:1rem}
    .btn.secondary{background:#333}
    .btn:active{transform:scale(.98)}
    .muted{color:#666;font-size:.95rem}
    #canvas{width:100%;max-height:70vh;background:#f6f6f6;border-radius:12px;display:none}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input[type="file"]{width:100%}
    label{display:block;font-weight:600;margin:8px 0 4px}
    .hint{font-size:.9rem;color:#555}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“¸ Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© ÙˆØ´Ø§Ø±ÙƒÙ‡Ø§ Ù…Ø¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ù‡Ù‰</h1>
      <p class="muted">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„ØªÙ‚Ø·Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŒ Ø³Ù†Ø¶ÙŠÙ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ù‡Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>

      <label>ØµÙˆØ±ØªÙƒ</label>
      <input id="pick" type="file" accept="image/*" capture="environment" />

      <div class="row">
        <div style="flex:1">
          <label>Ù†Øµ Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ù‡Ø§Ø´ØªØ§Ù‚/Ø­Ø³Ø§Ø¨)</label>
          <input id="caption" placeholder="#Ù‚Ù‡ÙˆØ©_Ø³Ø¹ÙŠØ¯Ø© @CafeName" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:12px" />
          <div class="hint">Ø³ÙŠØ¸Ù‡Ø± Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø©.</div>
        </div>
        <div style="width:140px">
          <label>Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø±</label>
          <input id="logoScale" type="range" min="0.2" max="1.5" step="0.1" value="0.6" style="width:100%" />
          <div class="small">Ø­Ø±Ù‘Ùƒ Ù„Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù…</div>
        </div>
      </div>

      <canvas id="canvas"></canvas>

      <div class="actions">
        <button class="btn" id="shareBtn">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø¸Ø§Ù…)</button>
        <button class="btn secondary" id="downloadBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
        <button class="btn secondary" id="copyBtn">ğŸ“‹ Ù†Ø³Ø® Ù„Ù„ØµÙ‚ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
        <div class="muted" id="msg"></div>
      </div>

      <p class="hint" style="margin-top:10px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ù…ØªØµÙØ­Ø§Øª ÙˆØ£Ø¬Ù‡Ø²Ø© ØªØ¯Ø¹Ù… <b>Web Share</b> Ø¹Ø¨Ø± HTTPS. Ø¥Ù† Ù„Ù… ØªØ¹Ù…Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± <b>ØªÙ†Ø²ÙŠÙ„</b> Ø£Ùˆ <b>Ù†Ø³Ø®</b>.
      </p>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const LOGO_SRC = 'assets/logo.png';              // Ø¶Ø¹ Ø´Ø¹Ø§Ø±Ùƒ Ù‡Ù†Ø§ (PNG Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ©)
    const TARGET_RATIO = 9/16;                       // Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Øµ (Ù‚ØµØµ 9:16)
    const PADDING = 24;                              // Ø­ÙˆØ§Ù Ø¯Ø§Ø®Ù„ÙŠØ©
    const EXPORT_WIDTH = 1080;                       // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬

    // ---- ELEMENTS ----
    const input = document.getElementById('pick');
    const canvas = document.getElementById('canvas');
    const shareBtn = document.getElementById('shareBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');
    const msg = document.getElementById('msg');
    const captionInput = document.getElementById('caption');
    const logoScaleInput = document.getElementById('logoScale');

    const ctx = canvas.getContext('2d');
    const logo = new Image();
    logo.src = LOGO_SRC;
    let userImg = new Image();
    let composedBlob = null;

    function readFile(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function drawComposite() {
      if (!userImg.complete || userImg.naturalWidth === 0) return;
      const W = EXPORT_WIDTH;
      const H = Math.round(W / TARGET_RATIO);
      canvas.width = W;
      canvas.height = H;

      // background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);

      // cover 9:16
      const srcW = userImg.naturalWidth, srcH = userImg.naturalHeight;
      const targetR = W/H, imgR = srcW/srcH;
      let sx, sy, sw, sh;
      if (imgR > targetR) { sh = srcH; sw = sh * targetR; sx = (srcW - sw)/2; sy = 0; }
      else { sw = srcW; sh = sw / targetR; sx = 0; sy = (srcH - sh)/2; }
      ctx.drawImage(userImg, sx, sy, sw, sh, 0, 0, W, H);

      // caption
      const caption = captionInput.value.trim();
      if (caption) {
        ctx.font = 'bold 42px system-ui, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        const textW = ctx.measureText(caption).width;
        const padX = 16, padY = 10;
        const boxW = textW + padX*2, boxH = 54 + padY;
        const boxX = (W - boxW)/2, boxY = H - PADDING - boxH;
        if (!CanvasRenderingContext2D.prototype.roundRect) {
          CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
            if (w < 2*r) r = w/2; if (h < 2*r) r = h/2;
            this.beginPath(); this.moveTo(x+r,y);
            this.arcTo(x+w,y,x+w,y+h,r); this.arcTo(x+w,y+h,x,y+h,r);
            this.arcTo(x,y+h,x,y,r); this.arcTo(x,y,x+w,y,r);
            this.closePath(); return this;
          }
        }
        ctx.fillStyle = 'rgba(0,0,0,0.35)';
        ctx.roundRect(boxX, boxY, boxW, boxH, 12); ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.fillText(caption, W/2, H - PADDING - 12);
      }

      // logo
      if (logo.complete && logo.naturalWidth > 0) {
        const s = parseFloat(logoScaleInput.value || '0.6');
        const baseSize = Math.min(W, H) * 0.22 * s;
        const ratio = logo.naturalWidth / logo.naturalHeight;
        let lw = baseSize, lh = baseSize / ratio;
        if (ratio < 1) { lh = baseSize; lw = baseSize * ratio; }
        const lift = (caption ? 70 : 0);
        const x = W - PADDING - lw;
        const y = H - PADDING - lh - lift;
        ctx.drawImage(logo, x, y, lw, lh);
      }

      canvas.style.display = 'block';
      composedBlob = null; // new render -> discard previous blob
    }

    input.addEventListener('change', async (e)=>{
      msg.textContent = '';
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { msg.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©.'; return; }
      const dataURL = await readFile(file);
      userImg = new Image();
      userImg.onload = drawComposite;
      userImg.src = dataURL;
    });

    logo.onload = () => { if (userImg.complete) drawComposite(); };
    captionInput.addEventListener('input', drawComposite);
    logoScaleInput.addEventListener('input', drawComposite);

    async function getBlob() {
      return new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/png', 0.95));
    }

    // --- SHARE (native share sheet) ---
    shareBtn.addEventListener('click', async ()=>{
      msg.textContent = '';
      if (canvas.style.display === 'none') { msg.textContent = 'Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      const blob = composedBlob || await getBlob();
      if (!blob) { msg.textContent = 'ØªØ¹Ø°Ø± ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø©.'; return; }
      composedBlob = blob;
      const file = new File([blob], 'coffee-story.png', { type: 'image/png' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'Ù‚ØµØªÙŠ Ù…Ø¹ Ø§Ù„Ù‚Ù‡ÙˆØ©',
            text: captionInput.value || 'ÙˆÙ‚Øª Ø§Ù„Ù‚Ù‡ÙˆØ© â˜•'
          });
          msg.textContent = 'ØªÙ… ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©. Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ØªÙØ¶Ù„Ù‡.';
        } catch (e) {
          msg.textContent = 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù†Ø³Ø®.';
        }
      } else {
        msg.textContent = 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ØªØµÙØ­. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù†Ø³Ø®.';
      }
    });

    // --- DOWNLOAD fallback ---
    downloadBtn.addEventListener('click', async ()=>{
      if (canvas.style.display === 'none') { msg.textContent = 'Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      const blob = composedBlob || await getBlob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'coffee-story.png';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      msg.textContent = 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø±Ù‡Ø§ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡.';
    });

    // --- COPY fallback (Clipboard w/ images on many devices) ---
    copyBtn.addEventListener('click', async ()=>{
      if (canvas.style.display === 'none') { msg.textContent = 'Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      try {
        const blob = composedBlob || await getBlob();
        if (navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
          msg.textContent = 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ØµÙˆØ±Ø©. Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„ØµÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹.';
        } else {
          msg.textContent = 'Ø§Ù„Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„.';
        }
      } catch(e) {
        msg.textContent = 'Ù„Ù… Ù†Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„Ù†Ø³Ø®. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„.';
      }
    });

    // UX: hint if not HTTPS (web share often blocked)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      msg.textContent = 'ØªÙ„Ù…ÙŠØ­: ÙØ¹Ù‘Ù„ HTTPS Ù„ÙŠØ¹Ù…Ù„ Ø²Ø± "Ù…Ø´Ø§Ø±ÙƒØ©" Ø¹Ù„Ù‰ Ø£ØºÙ„Ø¨ Ø§Ù„Ù‡ÙˆØ§ØªÙ.';
    }
  </script>
</body>
</html>
